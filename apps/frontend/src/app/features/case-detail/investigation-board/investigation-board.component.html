<!-- Board Container -->
<div #boardContainer class="board-container" [class.is-interacting]="isInteracting()"
  (mousedown)="onBoardMouseDown($event)" (mousemove)="onBoardMouseMove($event)" (mouseup)="onBoardMouseUp($event)" (wheel)="onBoardWheel($event)">
  <!-- Grid Background -->
  @if (tools().isGridVisible) {
  <div class="board-grid" [style.background-size]="gridSize() + 'px ' + gridSize() + 'px'"
    [style.transform]="'translate(' + viewport().panX + 'px, ' + viewport().panY + 'px) scale(' + viewport().zoom + ')'">
  </div>
  }

  <!-- SVG Filters for Connection Styles -->
  <svg class="connections-layer"
    [style.transform]="'translate(' + viewport().panX + 'px, ' + viewport().panY + 'px) scale(' + viewport().zoom + ')'">
    <defs>
      <filter id="yarn-filter">
        <feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="3" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="2" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </defs>

    <!-- Connection Paths -->
    @for (connection of uiConnections(); track connection.id) {
    <g>
      <!-- Clickable hit area (wider, invisible) -->
      <path [attr.d]="connection.ui.pathD" stroke="transparent" stroke-width="12" fill="transparent"
        style="pointer-events: stroke; cursor: pointer;" (click)="onYarnClick(connection.id, $event)" />
      <!-- Visible connection line -->
      <path [attr.d]="connection.ui.pathD" [attr.stroke]="connection.metadata.color"
        [attr.stroke-width]="connection.strength * 2" [attr.stroke-dasharray]="connection.metadata.lineStyle === 'dashed' ? '5,5' :
                                 connection.metadata.lineStyle === 'dotted' ? '1,5' : 'none'" fill="transparent"
        class="connection-path" [class.inactive]="!connection.metadata.isActive" [class.deletable]="mode() === 'delete'"
        [class.yarn-disputed]="connection.ui.trustClass === 'yarn-disputed'"
        [class.yarn-disproven]="connection.ui.trustClass === 'yarn-disproven'"
        style="pointer-events: none;" />
      <!-- Connection type indicator at midpoint -->
      @if (tools().showLabels && connection.metadata.label) {
      <text [attr.x]="connection.ui.midpoint.x" [attr.y]="connection.ui.midpoint.y - 10"
        text-anchor="middle" class="connection-label">
        {{ connection.metadata.label }}
      </text>
      }
      <!-- Trust warning icon on disputed connections -->
      @if (connection.ui.trustClass === 'yarn-disputed') {
      <text [attr.x]="connection.ui.midpoint.x" [attr.y]="connection.ui.midpoint.y + 5"
        text-anchor="middle" class="trust-warning-icon" style="font-size: 14px; pointer-events: none;">
        ‚ö†Ô∏è
      </text>
      }
    </g>
    }

    <!-- Temporary connection line (while drawing) -->
    @if (isDrawingConnection() && tempConnection()) {
    <path [attr.d]="getTempConnectionPathD()" stroke="#3B82F6" stroke-width="2" stroke-dasharray="5,5"
      fill="transparent" />
    }
  </svg>

  <!-- Nodes Layer -->
  <div class="nodes-layer"
    [style.transform]="'translate(' + viewport().panX + 'px, ' + viewport().panY + 'px) scale(' + viewport().zoom + ')'">
    <!-- Evidence Nodes -->
    @for (node of evidenceNodes(); track node.id) {
    <div class="board-node evidence" [style.left.px]="node.position.x" [style.top.px]="node.position.y"
      [style.width.px]="node.size.width" [style.height.px]="node.size.height" [style.zIndex]="node.zIndex"
      [class.selected]="node.isSelected" [class.dragging]="node.isDragging" [class.mode-connect]="mode() === 'connect'"
      [class.mode-delete]="mode() === 'delete'" [class.trust-disputed]="node.ui.trustLevel === 'disputed'"
      [class.trust-disproven]="node.ui.trustLevel === 'disproven'"
      [class.trust-verified]="node.ui.trustLevel === 'verified'"
      (mousedown)="onNodeMouseDown(node.id, $event)">
      <!-- Trust Badge -->
      <div class="trust-badge" [title]="node.ui.trustLevel">
        {{ node.ui.trustBadge }}
      </div>
      <!-- Polaroid Preview -->
      <div class="polaroid-preview">
        <div class="polaroid-img">{{ node.metadata.icon }}</div>
        <div class="polaroid-title">{{ node.ui.title }}</div>
        <div class="polaroid-desc">{{ node.ui.description }}</div>
      </div>
      <div class="node-header">üìé {{ node.ui.title }}</div>
      <div class="node-body">
        @if (node.isSelected) {
        <div style="margin-top: 5px; font-size: 0.65rem; color: #999;">
          {{ node.position.x | number:'1.0-0' }}, {{ node.position.y | number:'1.0-0' }}
        </div>
        }
      </div>
    </div>
    }

    <!-- Hypothesis Nodes -->
    @for (node of hypothesisNodes(); track node.id) {
    <div class="board-node hypothesis" [style.left.px]="node.position.x" [style.top.px]="node.position.y"
      [style.width.px]="node.size.width" [style.height.px]="node.size.height" [style.zIndex]="node.zIndex + 10"
      [class.selected]="node.isSelected" [class.dragging]="node.isDragging"
      [class.confidence-high]="node.ui.confidence === 'high'"
      [class.confidence-medium]="node.ui.confidence === 'medium'"
      [class.confidence-low]="node.ui.confidence === 'low'" (mousedown)="onNodeMouseDown(node.id, $event)">
      <div class="node-header">
        üß† {{ node.ui.title }}
        <span style="float: right; font-size: 0.7rem;">{{ node.ui.confidence | uppercase }}</span>
      </div>
      <!-- Hypothesis Preview (Sticky Note Style) -->
      <div class="hypothesis-preview">
        <div class="sticky-note-content">
          <div style="font-weight: 900; border-bottom: 1px solid black; margin-bottom: 5px;">HYPOTHESIS</div>
          {{ node.ui.description }}
        </div>
      </div>
      <div class="node-body">
        <div style="margin-top: 5px; font-weight: bold; font-size: 0.7rem;">
          {{ node.ui.supportingCount }} evidence linked
        </div>
      </div>
    </div>
    }

    <!-- Yarn Inspector (positioned in board space) -->
    @if (showYarnInspector()) {
    <cb-yarn-inspector [connection]="inspectedConnection()" [posX]="yarnInspectorPos().x" [posY]="yarnInspectorPos().y"
      (closed)="onYarnInspectorClose()" (deleted)="onYarnDeleted()"></cb-yarn-inspector>
    }
  </div>

  <!-- Empty State -->
  @if (nodes().length === 0) {
  <div class="board-empty-state">
    <div style="font-size: 3rem;">üß†</div>
    <h3>No nodes on the board</h3>
    <p>Add evidence or create hypotheses.</p>
  </div>
  }
</div>

<!-- Connection Modal ("Why?") -->
@if (showConnectionModal()) {
<cb-connection-modal [sourceLabel]="pendingSourceLabel()" [targetLabel]="pendingTargetLabel()"
  [suggestedTokens]="pendingSuggestedTokens()" (confirmed)="onConnectionConfirmed($event)"
  (cancelled)="onConnectionCancelled()"></cb-connection-modal>
}

<!-- Path Creator Toggle -->
<button class="brutal-btn"
  style="position: absolute; bottom: 20px; right: 20px; background: var(--orange); z-index: 30;"
  (click)="isPathPanelOpen.set(!isPathPanelOpen())" title="Investigation Paths">
  üß≠ Paths
</button>

<!-- Path Creator Panel -->
<div class="side-panel" [class.open]="isPathPanelOpen()">
  <cb-path-creator #pathCreator></cb-path-creator>
</div>