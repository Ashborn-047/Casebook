<!-- Board Container -->
<div #boardContainer class="board-container" (mousedown)="onBoardMouseDown($event)"
  (mousemove)="onBoardMouseMove($event)" (mouseup)="onBoardMouseUp($event)" (wheel)="onBoardWheel($event)">
  <!-- Grid Background -->
  <div *ngIf="tools().isGridVisible" class="board-grid" [style.background-size]="gridSize() + 'px ' + gridSize() + 'px'"
    [style.transform]="'translate(' + viewport().panX + 'px, ' + viewport().panY + 'px) scale(' + viewport().zoom + ')'">
  </div>

  <!-- Connections Layer (SVG) -->
  <svg class="connections-layer"
    [style.transform]="'translate(' + viewport().panX + 'px, ' + viewport().panY + 'px) scale(' + viewport().zoom + ')'">
    <g *ngFor="let connection of connections()">
      <path [attr.d]="getConnectionPathD(connection)" [attr.stroke]="connection.metadata.color"
        [attr.stroke-width]="connection.strength * 2" [attr.stroke-dasharray]="connection.metadata.lineStyle === 'dashed' ? '5,5' :
                                 connection.metadata.lineStyle === 'dotted' ? '1,5' : 'none'" fill="transparent"
        class="connection-path" [class.inactive]="!connection.metadata.isActive" [class.deletable]="mode() === 'delete'"
        (click)="onConnectionClick(connection.id)" />

      <text *ngIf="tools().showLabels && connection.metadata.label" [attr.x]="getConnectionMidpoint(connection).x"
        [attr.y]="getConnectionMidpoint(connection).y - 10" text-anchor="middle" class="connection-label">
        {{ connection.metadata.label }}
      </text>
    </g>

    <!-- Temporary connection line (while drawing) -->
    <path *ngIf="isDrawingConnection && tempConnection()" [attr.d]="getTempConnectionPathD()" stroke="#3B82F6"
      stroke-width="2" stroke-dasharray="5,5" fill="transparent" />
  </svg>

  <!-- Nodes Layer -->
  <div class="nodes-layer"
    [style.transform]="'translate(' + viewport().panX + 'px, ' + viewport().panY + 'px) scale(' + viewport().zoom + ')'">
    <!-- Evidence Nodes -->
    <div *ngFor="let node of evidenceNodes()" class="board-node evidence" [style.left.px]="node.position.x"
      [style.top.px]="node.position.y" [style.width.px]="node.size.width" [style.height.px]="node.size.height"
      [style.zIndex]="node.zIndex" [class.selected]="node.isSelected" [class.dragging]="node.isDragging"
      [class.mode-connect]="mode() === 'connect'" [class.mode-delete]="mode() === 'delete'"
      (mousedown)="onNodeMouseDown(node.id, $event)">

      <!-- Polaroid Preview -->
      <div class="polaroid-preview">
        <div class="polaroid-img">{{ node.metadata.icon }}</div>
        <div style="font-weight:bold; font-size: 0.7rem;">{{ getNodeTitle(node) }}</div>
      </div>

      <div class="node-header">ðŸ“Ž {{ getNodeTitle(node) }}</div>
      <div class="node-body">
        {{ getNodeDescription(node) }}
        <div *ngIf="node.isSelected" style="margin-top: 5px; font-size: 0.65rem; color: #999;">
          {{ node.position.x | number:'1.0-0' }}, {{ node.position.y | number:'1.0-0' }}
        </div>
      </div>
    </div>

    <!-- Hypothesis Nodes -->
    <div *ngFor="let node of hypothesisNodes()" class="board-node hypothesis" [style.left.px]="node.position.x"
      [style.top.px]="node.position.y" [style.width.px]="node.size.width" [style.height.px]="node.size.height"
      [style.zIndex]="node.zIndex + 10" [class.selected]="node.isSelected" [class.dragging]="node.isDragging"
      [class.confidence-high]="getHypothesisConfidence(node) === 'high'"
      [class.confidence-medium]="getHypothesisConfidence(node) === 'medium'"
      [class.confidence-low]="getHypothesisConfidence(node) === 'low'" (mousedown)="onNodeMouseDown(node.id, $event)">

      <div class="node-header">
        ðŸ§  {{ getNodeTitle(node) }}
        <span style="float: right; font-size: 0.7rem;">{{ getHypothesisConfidence(node) | uppercase }}</span>
      </div>
      <div class="node-body">
        {{ getNodeDescription(node) }}
        <div style="margin-top: 5px; font-weight: bold; font-size: 0.7rem;">
          {{ getSupportingEvidenceCount(node) }} evidence linked
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="nodes().length === 0" class="board-empty-state">
    <div style="font-size: 3rem;">ðŸ§ </div>
    <h3>No nodes on the board</h3>
    <p>Add evidence or create hypotheses.</p>
  </div>
</div>

<!-- Path Creator Toggle -->
<button class="brutal-btn" style="position: fixed; bottom: 20px; right: 20px; background: var(--orange); z-index: 30;"
  (click)="isPathPanelOpen.set(!isPathPanelOpen())" title="Investigation Paths">
  ðŸ§­ Paths
</button>

<!-- Path Creator Panel -->
<div class="side-panel" [class.open]="isPathPanelOpen()">
  <cb-path-creator #pathCreator></cb-path-creator>
</div>