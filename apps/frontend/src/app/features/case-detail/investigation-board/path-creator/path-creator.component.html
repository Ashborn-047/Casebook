<div class="brutal-card" style="height: 100%; overflow-y: auto; padding: 15px;">

    <!-- Header -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid black; padding-bottom: 10px;">
        <h3 style="margin: 0;">üß≠ Investigation Paths</h3>
        <button class="brutal-btn" style="padding: 4px 10px; font-size: 1rem;" (click)="toggle()">‚úï</button>
    </div>

    <!-- Building Mode -->
    <div *ngIf="isBuilding()">
        <div class="form-group">
            <label>Path Title *</label>
            <input type="text" [ngModel]="pathTitle()" (ngModelChange)="pathTitle.set($event)"
                placeholder="e.g., Timeline of intrusion">
        </div>

        <div class="form-group">
            <label>Description</label>
            <textarea [ngModel]="pathDescription()" (ngModelChange)="pathDescription.set($event)"
                placeholder="What does this path demonstrate?" rows="2"></textarea>
        </div>

        <!-- Evidence Picker -->
        <div class="form-group">
            <label>Select Evidence ({{ selectedEvidenceIds().length }} selected)</label>
            <div style="max-height: 200px; overflow-y: auto; border: 2px solid black; padding: 5px;">
                <div *ngFor="let evidence of availableEvidence()"
                    style="padding: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #eee;"
                    [style.background]="isSelected(evidence.id) ? 'var(--lime)' : 'white'"
                    (click)="toggleEvidence(evidence.id)">
                    <span *ngIf="isSelected(evidence.id)" class="badge"
                        style="background: black; color: white; padding: 2px 6px;">
                        {{ getSequenceNumber(evidence.id) }}
                    </span>
                    <span>{{ evidence.visibility === 'restricted' ? 'üîí' : 'üîç' }}</span>
                    <span style="font-size: 0.8rem;">{{ evidence.description }}</span>
                </div>
                <div *ngIf="availableEvidence().length === 0" style="padding: 10px; text-align: center; color: #999;">
                    No evidence available
                </div>
            </div>
        </div>

        <!-- Sequence Preview -->
        <div *ngIf="sequencedEvidence().length > 0" class="form-group">
            <label>Path Sequence</label>
            <div *ngFor="let ev of sequencedEvidence(); let i = index"
                style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #ccc;">
                <span class="badge" style="background: var(--yellow); padding: 2px 8px; font-weight: 900;">{{ i + 1
                    }}</span>
                <span style="flex: 1; font-size: 0.8rem;">{{ ev.description }}</span>
                <button class="brutal-btn" style="padding: 2px 6px; font-size: 0.7rem;" (click)="moveUp(i)"
                    [disabled]="i === 0">‚Üë</button>
                <button class="brutal-btn" style="padding: 2px 6px; font-size: 0.7rem;" (click)="moveDown(i)"
                    [disabled]="i === sequencedEvidence().length - 1">‚Üì</button>
                <button class="brutal-btn" style="padding: 2px 6px; font-size: 0.7rem; background: var(--pink);"
                    (click)="removeFromSequence(i)">‚úï</button>
            </div>
        </div>

        <div class="form-group">
            <label>Summary</label>
            <textarea [ngModel]="pathSummary()" (ngModelChange)="pathSummary.set($event)"
                placeholder="Summarise the narrative" rows="2"></textarea>
        </div>

        <!-- Actions -->
        <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button class="brutal-btn" style="flex: 1;" (click)="cancelBuilding()">Cancel</button>
            <button class="brutal-btn" style="flex: 2; background: var(--lime);" [disabled]="!canSave() || isSaving()"
                (click)="savePath()">
                {{ isSaving() ? 'Saving...' : 'Save Path ‚ö°' }}
            </button>
        </div>
    </div>

    <!-- List Mode -->
    <div *ngIf="!isBuilding()">
        <button *ngIf="canCreate()" class="brutal-btn"
            style="width: 100%; margin-bottom: 15px; background: var(--lime);" (click)="startBuilding()">
            + Create New Path
        </button>

        <div *ngIf="savedPaths().length === 0" style="text-align: center; padding: 20px; color: #999;">
            <p>No investigation paths yet.</p>
            <p style="font-size: 0.8rem;">Create a path to sequence evidence into a narrative.</p>
        </div>

        <div *ngFor="let path of savedPaths()" class="brutal-card"
            style="margin-bottom: 10px; padding: 12px; cursor: pointer;" (click)="togglePath(path.id)">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>üß≠</span>
                <div style="flex: 1;">
                    <h4 style="margin: 0;">{{ path.title }}</h4>
                    <span style="font-size: 0.75rem; color: #666;">{{ path.sequence.length }} steps ¬∑ {{ path.createdAt
                        | date:'short' }}</span>
                </div>
                <span>{{ expandedPathId() === path.id ? '‚ñæ' : '‚ñ∏' }}</span>
            </div>

            <div *ngIf="expandedPathId() === path.id"
                style="margin-top: 10px; padding-top: 10px; border-top: 2px solid black;">
                <p *ngIf="path.description" style="font-size: 0.85rem; margin-bottom: 10px;">{{ path.description }}</p>
                <div *ngFor="let evidenceId of path.sequence; let i = index"
                    style="display: flex; align-items: center; gap: 8px; padding: 4px 0;">
                    <span class="badge" style="background: var(--yellow); padding: 2px 6px;">{{ i + 1 }}</span>
                    <span style="font-size: 0.8rem;">{{ getEvidenceForId(evidenceId)?.description || evidenceId
                        }}</span>
                </div>
                <p *ngIf="path.summary" style="margin-top: 10px; font-weight: bold; font-size: 0.85rem;">
                    Summary: {{ path.summary }}
                </p>
            </div>
        </div>
    </div>
</div>